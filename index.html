<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dodoliu.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="爱生活，爱折腾！">
<meta property="og:type" content="website">
<meta property="og:title" content="dodoliu的折腾笔记">
<meta property="og:url" content="http://dodoliu.github.io/index.html">
<meta property="og:site_name" content="dodoliu的折腾笔记">
<meta property="og:description" content="爱生活，爱折腾！">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="dodoliu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://dodoliu.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>dodoliu的折腾笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="dodoliu的折腾笔记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dodoliu的折腾笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">生命不息，折腾不止！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/vue-use-hkvscamera-nonuse-websdk">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/vue-use-hkvscamera-nonuse-websdk" class="post-title-link" itemprop="url">不使用海康威视的WEBSDK如何在浏览器中展示实时视频流</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-24 10:52:14 / 修改时间：10:58:09" itemprop="dateCreated datePublished" datetime="2021-12-24T10:52:14+08:00">2021-12-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>海康威视官方提供了Web3.0和Web3.2的SDK,</p>
<p>Web3.0需要浏览器支持NPAPI,但是高版本的浏览器都已经禁用了这种功能.</p>
<p>Web3.2需要设备支持WebSocket.</p>
<p>这两个Web SDK都无法适用于高版本浏览器显示海康威视老设备的视频流.</p>
<p>无奈只能求助官方技术支持.</p>
<p>官方技术支持响应还是很迅速的.描述完我的需求后,技术小哥哥(小姐姐)立马给我了一个方案(估计是被咨询了很多次):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">您可以用RTSP协议取流，然后用第三方比如FFmpeg对数据处理成FLV或者RTMP，在谷歌网页上播放</span><br></pre></td></tr></table></figure>

<p>又经过一通查询发现高版本浏览器也不支持RTMP流的显示了.只能使用flv,然后使用bilibili开源的flv.js进行展示.</p>
<p>方案确认了,那还愁啥,搞起来!嗨起来!</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>因为我的项目部署环境是windows,所以所有软件都是windows版本.</p>
<p>ffmpeg下载地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ffmpeg.org/download.html#build-windows</span><br></pre></td></tr></table></figure>

<p>通过查询,rtsp要处理成flv需要借助nginx的nginx-http-flv-module模块.windows下编译带该模块的nginx超级麻烦,不过有人在CSDN上提供了编译好后的可用包.</p>
<p>下载地址:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://download.csdn.net/download/KayChanGEEK/12270210</span><br></pre></td></tr></table></figure>

<p>为了方便测试,建议再下载一个vlc:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.videolan.org/</span><br></pre></td></tr></table></figure>

<h2 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h2><p>配置文件参考</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line"># multiple workers works !</span><br><span class="line">worker_processes  2;</span><br><span class="line"> </span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"> </span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"> </span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  8192;</span><br><span class="line">    # max value 32768, nginx recycling connections+registry optimization = </span><br><span class="line">    #   this.value * 20 = max concurrent connections currently tested with one worker</span><br><span class="line">    #   C1000K should be possible depending there is enough ram/cpu power</span><br><span class="line">    # multi_accept on;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">rtmp &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1935;</span><br><span class="line">        chunk_size 4000;</span><br><span class="line">        application live &#123;</span><br><span class="line">             live on;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">http &#123;</span><br><span class="line">    #include      /nginx/conf/naxsi_core.rules;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"> </span><br><span class="line">    #log_format  main  &#x27;$remote_addr:$remote_port - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"> </span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"> </span><br><span class="line">#     # loadbalancing PHP</span><br><span class="line">#     upstream myLoadBalancer &#123;</span><br><span class="line">#         server 127.0.0.1:9001 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9002 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9003 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9004 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9005 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9006 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9007 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9008 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9009 weight=1 fail_timeout=5;</span><br><span class="line">#         server 127.0.0.1:9010 weight=1 fail_timeout=5;</span><br><span class="line">#         least_conn;</span><br><span class="line">#     &#125;</span><br><span class="line"> </span><br><span class="line">    sendfile        off;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"> </span><br><span class="line">    server_names_hash_bucket_size 128;</span><br><span class="line"> </span><br><span class="line">## Start: Timeouts ##</span><br><span class="line">    client_body_timeout   10;</span><br><span class="line">    client_header_timeout 10;</span><br><span class="line">    keepalive_timeout     30;</span><br><span class="line">    send_timeout          10;</span><br><span class="line">    keepalive_requests    10;</span><br><span class="line">## End: Timeouts ##</span><br><span class="line"> </span><br><span class="line">    #gzip  on;</span><br><span class="line"> </span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        location /stat &#123;</span><br><span class="line">            rtmp_stat all;</span><br><span class="line">            rtmp_stat_stylesheet stat.xsl;</span><br><span class="line">        &#125;</span><br><span class="line">        location /stat.xsl &#123;</span><br><span class="line">            root nginx-rtmp-module/;</span><br><span class="line">        &#125;</span><br><span class="line">        location /control &#123;</span><br><span class="line">            rtmp_control all;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    # 重要 http-flv  转流配置 </span><br><span class="line">        location /live &#123;</span><br><span class="line">            flv_live on; #打开 HTTP 播放 FLV 直播流功能</span><br><span class="line">            chunked_transfer_encoding on; #支持 &#x27;Transfer-Encoding: chunked&#x27; 方式回复</span><br><span class="line"> </span><br><span class="line">            add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;; #添加额外的 HTTP 头</span><br><span class="line">            add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;; #添加额外的 HTTP 头</span><br><span class="line">            add_header &#x27;Cache-Control&#x27; &#x27;no-cache&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        #charset koi8-r;</span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"> </span><br><span class="line">        ## Caching Static Files, put before first location</span><br><span class="line">        #location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ &#123;</span><br><span class="line">        #    expires 14d;</span><br><span class="line">        #    add_header Vary Accept-Encoding;</span><br><span class="line">        #&#125;</span><br><span class="line"> </span><br><span class="line"># For Naxsi remove the single # line for learn mode, or the ## lines for full WAF mode</span><br><span class="line">        location / &#123;</span><br><span class="line">      add_header Cache-Control no-cache;</span><br><span class="line">      add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27; always;</span><br><span class="line">      add_header &#x27;Access-Control-Expose-Headers&#x27; &#x27;Content-Length,Content-Range&#x27;;</span><br><span class="line">      add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;Range&#x27;;</span><br><span class="line">    </span><br><span class="line">            #include    /nginx/conf/mysite.rules; # see also http block naxsi include line</span><br><span class="line">            ##SecRulesEnabled;</span><br><span class="line">         ##DeniedUrl &quot;/RequestDenied&quot;;</span><br><span class="line">         ##CheckRule &quot;$SQL &gt;= 8&quot; BLOCK;</span><br><span class="line">         ##CheckRule &quot;$RFI &gt;= 8&quot; BLOCK;</span><br><span class="line">         ##CheckRule &quot;$TRAVERSAL &gt;= 4&quot; BLOCK;</span><br><span class="line">         ##CheckRule &quot;$XSS &gt;= 8&quot; BLOCK;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line"># For Naxsi remove the ## lines for full WAF mode, redirect location block used by naxsi</span><br><span class="line">        ##location /RequestDenied &#123;</span><br><span class="line">        ##    return 412;</span><br><span class="line">        ##&#125;</span><br><span class="line"> </span><br><span class="line">## Lua examples !</span><br><span class="line">#         location /robots.txt &#123;</span><br><span class="line">#           rewrite_by_lua &#x27;</span><br><span class="line">#             if ngx.var.http_host ~= &quot;localhost&quot; then</span><br><span class="line">#               return ngx.exec(&quot;/robots_disallow.txt&quot;);</span><br><span class="line">#             end</span><br><span class="line">#           &#x27;;</span><br><span class="line">#         &#125;</span><br><span class="line"> </span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"> </span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    proxy_pass   http://127.0.0.1;</span><br><span class="line">        #&#125;</span><br><span class="line"> </span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   127.0.0.1:9000; # single backend process</span><br><span class="line">        #    fastcgi_pass   myLoadBalancer; # or multiple, see example above</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line"> </span><br><span class="line">        # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">        # concurs with nginx&#x27;s one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    # another virtual host using mix of IP-, name-, and port-based configuration</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       8000;</span><br><span class="line">    #    listen       somename:8080;</span><br><span class="line">    #    server_name  somename  alias  another.alias;</span><br><span class="line"> </span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"> </span><br><span class="line">    # HTTPS server</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       443 ssl spdy;</span><br><span class="line">    #    server_name  localhost;</span><br><span class="line"> </span><br><span class="line">    #    ssl                  on;</span><br><span class="line">    #    ssl_certificate      cert.pem;</span><br><span class="line">    #    ssl_certificate_key  cert.key;</span><br><span class="line">    #    ssl_session_timeout  5m;</span><br><span class="line">    #    ssl_prefer_server_ciphers On;</span><br><span class="line">    #    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    #    ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:ECDH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!eNULL:!MD5:!DSS:!EXP:!ADH:!LOW:!MEDIUM;</span><br><span class="line"> </span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有两个地方需要特殊说明:</p>
<p>第一处:这里是配置rtmp, 1935端口是默认端口.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rtmp &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1935;</span><br><span class="line">        chunk_size 4000;</span><br><span class="line">        application live &#123;</span><br><span class="line">             live on;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二处: flv拉流的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /live &#123;</span><br><span class="line">            flv_live on; #打开 HTTP 播放 FLV 直播流功能</span><br><span class="line">            chunked_transfer_encoding on; #支持 &#x27;Transfer-Encoding: chunked&#x27; 方式回复</span><br><span class="line"> </span><br><span class="line">            add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;*&#x27;; #添加额外的 HTTP 头</span><br><span class="line">            add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;; #添加额外的 HTTP 头</span><br><span class="line">            add_header &#x27;Cache-Control&#x27; &#x27;no-cache&#x27;;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="海康威视摄像头RTSP流获取"><a href="#海康威视摄像头RTSP流获取" class="headerlink" title="海康威视摄像头RTSP流获取"></a>海康威视摄像头RTSP流获取</h2><p>网上一堆介绍,可自行搜索学习.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rtsp://admin:123456@192.168.10.54:554/Streaming/Channels/101?transportmode=unicast</span><br><span class="line"></span><br><span class="line">rtsp:协议</span><br><span class="line">admin:摄像头登录用户名</span><br><span class="line">123456:摄像头登录密码</span><br><span class="line">192.168.10.54:摄像头ip</span><br><span class="line">554:拉rtsp流的端口</span><br><span class="line">101:通道表示(主码流通道)</span><br><span class="line">transportmode=unicast:传输模式</span><br></pre></td></tr></table></figure>

<h2 id="使用ffmpeg进行流转换"><a href="#使用ffmpeg进行流转换" class="headerlink" title="使用ffmpeg进行流转换"></a>使用ffmpeg进行流转换</h2><p>在命令行中输入一下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg  -rtsp_transport tcp -i rtsp://admin:123456@192.168.10.54:554/Streaming/Channels/101?transportmode=unicast -vcodec copy -an -acodec copy -f flv rtmp://127.0.0.1:1935/live/mystream</span><br><span class="line"></span><br><span class="line">rtmp://127.0.0.1:1935/live/mystream: 这个地址是nginx中配置的rtmp节点的地址, live是配置的app名称,mystream可以随意指定</span><br></pre></td></tr></table></figure>

<p>出现下图所示效果且进程不终止,表明转换流成功了.</p>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211213174237900.png" alt="image-20211213174237900"></p>
<p>有了上面的rtmp地址后,我们可以知道flv取流的地址为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/live?port=1935&amp;app=live&amp;stream=mystream</span><br><span class="line"></span><br><span class="line">这是通过nginx中http节点配置的.请注意app的值和stream的值</span><br><span class="line">对应的是</span><br><span class="line">rtmp://127.0.0.1:1935/live/mystream</span><br><span class="line">中的 live和mystream</span><br></pre></td></tr></table></figure>

<p>有了flv拉流的地址后,我们就可以在vlc中进行校验</p>
<h2 id="在vlc中进行测试"><a href="#在vlc中进行测试" class="headerlink" title="在vlc中进行测试"></a>在vlc中进行测试</h2><p>点击vlc菜单中的 “媒体”,然后选择 “流”</p>
<p>然后选择”网络”</p>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211213175059382.png" alt="image-20211213175059382"></p>
<p>然后将右下方的 “串流” 选择为 “播放”,在等待几秒后就可以看到正常的视频图像了.</p>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211213175204858.png" alt="image-20211213175204858"></p>
<p>如果没有显示,请继续爬坑吧!!!</p>
<h2 id="在vue中显示"><a href="#在vue中显示" class="headerlink" title="在vue中显示"></a>在vue中显示</h2><p>我的前端项目是个vue项目.</p>
<p>先安装flv.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save flv.js</span><br></pre></td></tr></table></figure>

<p>html主要代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;video</span><br><span class="line">  id=&quot;vPull&quot;</span><br><span class="line">  autoplay</span><br><span class="line">  style=&quot;height: 100%; width: 100%; object-fit: fill&quot;</span><br><span class="line">  muted</span><br><span class="line">&gt;&lt;/video&gt;</span><br></pre></td></tr></table></figure>

<p>js主要代码.</p>
<p>参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/HJFQC/article/details/109626836">https://blog.csdn.net/HJFQC/article/details/109626836</a></p>
<p>感谢原作者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mounted() &#123;</span><br><span class="line">  this.play(&quot;http://127.0.0.1/live?port=1935&amp;app=live&amp;stream=mystream&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我需要想说明一下如何调用,在mounted方法中直接调用play方法,然后传入准备好的flv流地址.</p>
<p>没有意外的话,vue项目启动后就可以正常查看视频了.</p>
<h2 id="net-core后台动态切换摄像头地址"><a href="#net-core后台动态切换摄像头地址" class="headerlink" title=".net core后台动态切换摄像头地址"></a>.net core后台动态切换摄像头地址</h2><p>经过上面所有操作后,我们已经可以在前端进行视频展示了.但是如果想切换摄像头该怎么搞?</p>
<p>可以参考以下思路:</p>
<p>通过后端代码进行ffmpeg的进程创建和关闭.</p>
<p>我的后端是.net core项目,参考代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 启动ffmpeg进程</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">[HttpGet(&quot;TestCmd54&quot;)]</span><br><span class="line">public async Task&lt;int&gt; TestCmd54()</span><br><span class="line">&#123;    </span><br><span class="line">    var psi = new System.Diagnostics.ProcessStartInfo(&quot;D:\\App\\ffmpeg\\bin\\ffmpeg.exe&quot;, &quot;-rtsp_transport tcp -i rtsp://admin:123456@192.168.10.54:554/Streaming/Channels/101?transportmode=unicast -vcodec copy -an -acodec copy -f flv rtmp://127.0.0.1:1935/live/mystream&quot;);</span><br><span class="line">    var ss = System.Diagnostics.Process.Start(psi);</span><br><span class="line">    return await Task.FromResult(ss.Id);</span><br><span class="line">&#125;</span><br><span class="line">/// &lt;summary&gt;</span><br><span class="line">/// 关闭ffmpeg进程</span><br><span class="line">/// &lt;/summary&gt;</span><br><span class="line">/// &lt;returns&gt;&lt;/returns&gt;</span><br><span class="line">[HttpGet(&quot;TestCmd54Stop&quot;)]</span><br><span class="line">public async Task&lt;int&gt; TestCmd54Stop(int processId)</span><br><span class="line">&#123; </span><br><span class="line">    var stopProcess = System.Diagnostics.Process.GetProcessById(processId);</span><br><span class="line">    if (!stopProcess.HasExited)</span><br><span class="line">    &#123;</span><br><span class="line">        stopProcess.Kill();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return await Task.FromResult(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/vue-use-hkvscamera-web3-0">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/vue-use-hkvscamera-web3-0" class="post-title-link" itemprop="url">Vue下使用海康威视WEB无插件开发包V3.2的使用记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-11-17 16:41:05 / 修改时间：17:26:15" itemprop="dateCreated datePublished" datetime="2021-11-17T16:41:05+08:00">2021-11-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>最近做的一个项目需要在Web页面上展示视频图像信息.</p>
<p>项目中使用的摄像头是海康威视的.经过一番捣鼓后终于可以正常显示图像了.</p>
<p>于是做个记录,供其他同学爬坑.</p>
<h2 id="开发准备"><a href="#开发准备" class="headerlink" title="开发准备"></a>开发准备</h2><h6 id="WEB无插件开发包-V3-2-官方下载地址"><a href="#WEB无插件开发包-V3-2-官方下载地址" class="headerlink" title="WEB无插件开发包 V3.2 官方下载地址:"></a>WEB无插件开发包 V3.2 官方下载地址:</h6><p><a target="_blank" rel="noopener" href="https://open.hikvision.com/download/5cda567cf47ae80dd41a54b3?type=10&amp;id=4c945d18fa5f49638ce517ec32e24e24">https://open.hikvision.com/download/5cda567cf47ae80dd41a54b3?type=10&amp;id=4c945d18fa5f49638ce517ec32e24e24</a></p>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211116165646268.png" alt="image-20211116165646268"></p>
<p>下载完成解压后包含以下内容:</p>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211116165802938.png" alt="image-20211116165802938"></p>
<h6 id="设备网络搜索软件下载地址"><a href="#设备网络搜索软件下载地址" class="headerlink" title="设备网络搜索软件下载地址:"></a>设备网络搜索软件下载地址:</h6><p><a target="_blank" rel="noopener" href="https://www.hikvision.com/cn/support/Downloads/Desktop-Application/HikvisionTools/?q=%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%EF%BC%88hikvision%20tools%EF%BC%89&amp;position=1">https://www.hikvision.com/cn/support/Downloads/Desktop-Application/HikvisionTools/?q=%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%EF%BC%88hikvision%20tools%EF%BC%89&amp;position=1</a></p>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211116170730350.png" alt="image-20211116170730350"></p>
<p>这是海康威视官方提供的用于发现相同局域网下所有设备的工具.效果如下图:</p>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211116170905290.png" alt="image-20211116170905290"></p>
<h6 id="一个海康威视的摄像头-需要支持WebSocket"><a href="#一个海康威视的摄像头-需要支持WebSocket" class="headerlink" title="一个海康威视的摄像头,需要支持WebSocket."></a>一个海康威视的摄像头,需要支持WebSocket.</h6><p>我这边测试用的摄像头是这一款:</p>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211116170300397.png" alt="image-20211116170300397"></p>
<p>==测试环境下需要保证摄像头和开发机器在同一个局域网内==</p>
<p>tips:</p>
<ol>
<li>如果通过 设备网络搜索软件SADP 无法发现你需要是设备,则表明你的开发机器的网络和设备的网络不通.</li>
<li>将摄像头设置为使用 DHCP</li>
</ol>
<p><img src="https://gitee.com/dodoliu/dodoliuimg/raw/master/2021/image-20211116171337535.png" alt="image-20211116171337535"></p>
<ol start="3">
<li>Vue开发环境下无法看到正常的视频图像,需要使用Nginx进行代理</li>
</ol>
<h2 id="快乐的码代码"><a href="#快乐的码代码" class="headerlink" title="快乐的码代码"></a>快乐的码代码</h2><h6 id="Vue代码可以借鉴这篇文章的"><a href="#Vue代码可以借鉴这篇文章的" class="headerlink" title="Vue代码可以借鉴这篇文章的"></a>Vue代码可以借鉴这篇文章的</h6><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Vslong/article/details/118517641">https://blog.csdn.net/Vslong/article/details/118517641</a></p>
<p>按照上面这篇文章码完Vue代码后如果想正常看到视频图片还需要完成以下操作:</p>
<h6 id="设置Vue代理"><a href="#设置Vue代理" class="headerlink" title="设置Vue代理"></a>设置Vue代理</h6><p>在Vue的Config文件夹下的index.js配置文件中设置proxyTable</p>
<p>参考:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">proxyTable: &#123;</span><br><span class="line">  &#x27;/ISAPI&#x27;: &#123;//配置代理地址，前端请求的所有接口都需要带的前缀</span><br><span class="line">    target: &#x27;http://192.168.10.51:12345&#x27;,  #我本地监控的Web3.2无插件Nginx代理地址</span><br><span class="line">    changeOrigin: true,//是否进行跨域</span><br><span class="line">    secure: false,</span><br><span class="line">    // logLevel: &#x27;debug&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#x27;/SDK&#x27;: &#123;</span><br><span class="line">    target: &#x27;http://192.168.10.51:12345&#x27;,</span><br><span class="line">    changeOrigin: true,</span><br><span class="line">    secure: false,</span><br><span class="line">    // logLevel: &#x27;debug&#x27;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h6 id="然后编译发布Vue代码-然后修改Nginx配置"><a href="#然后编译发布Vue代码-然后修改Nginx配置" class="headerlink" title="然后编译发布Vue代码,然后修改Nginx配置."></a>然后编译发布Vue代码,然后修改Nginx配置.</h6><p>参考:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line">    #access_log      off;</span><br><span class="line">    client_max_body_size 50m;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       12345;</span><br><span class="line">        server_name  192.168.10.51;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        access_log  logs/host.access.log  main;</span><br><span class="line">        #websocket相关配置</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line">      proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">      proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">      proxy_set_header X-real-ip $remote_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">    </span><br><span class="line">        proxy_set_header &#x27;sec-ch-ua&#x27; &quot;&quot;;</span><br><span class="line">        proxy_set_header &#x27;sec-ch-ua-mobile&#x27; &quot;&quot;;</span><br><span class="line">        proxy_set_header &#x27;sec-ch-ua-platform:&#x27; &quot;&quot;;</span><br><span class="line">        proxy_set_header &#x27;Sec-Fetch-Dest&#x27; &quot;&quot;;</span><br><span class="line">        proxy_set_header &#x27;Sec-Fetch-Mode&#x27; &quot;&quot;;</span><br><span class="line">        proxy_set_header &#x27;Sec-Fetch-Site&#x27; &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root &quot;../dist&quot;;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      location ~ /ISAPI|SDK/ &#123;</span><br><span class="line">          if ($http_cookie ~ &quot;webVideoCtrlProxy=(.+)&quot;) &#123;</span><br><span class="line">          proxy_pass http://$cookie_webVideoCtrlProxy;</span><br><span class="line">          break;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      location ^~ /webSocketVideoCtrlProxy &#123;</span><br><span class="line">          #web socket</span><br><span class="line">          proxy_http_version 1.1;</span><br><span class="line">          proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">          proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">          proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">          if ($http_cookie ~ &quot;webVideoCtrlProxyWs=(.+)&quot;) &#123;</span><br><span class="line">          proxy_pass http://$cookie_webVideoCtrlProxyWs/$cookie_webVideoCtrlProxyWsChannel?$args;</span><br><span class="line">          break;</span><br><span class="line">          &#125;</span><br><span class="line">          if ($http_cookie ~ &quot;webVideoCtrlProxyWss=(.+)&quot;) &#123;</span><br><span class="line">          proxy_pass http://$cookie_webVideoCtrlProxyWss/$cookie_webVideoCtrlProxyWsChannel?$args;</span><br><span class="line">          break;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        # error_page  302  /50x.html;</span><br><span class="line">        # location = /50x.html &#123;</span><br><span class="line">        #     root   html;</span><br><span class="line">        # &#125;</span><br><span class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    proxy_pass   http://127.0.0.1;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">        # concurs with nginx&#x27;s one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # another virtual host using mix of IP-, name-, and port-based configuration</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       8000;</span><br><span class="line">    #    listen       somename:8080;</span><br><span class="line">    #    server_name  somename  alias  another.alias;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # HTTPS server</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       443 ssl;</span><br><span class="line">    #    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #    ssl_certificate      cert.pem;</span><br><span class="line">    #    ssl_certificate_key  cert.key;</span><br><span class="line"></span><br><span class="line">    #    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    #    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    #    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上是无插件开发包自带的nginx配置,只简单修改了三处:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">监控端口:</span><br><span class="line">listen       12345;</span><br><span class="line">server_name  192.168.10.51;</span><br><span class="line">       </span><br><span class="line">静态文件根目录:       </span><br><span class="line">location / &#123;</span><br><span class="line">    root &quot;../dist&quot;;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">添加:</span><br><span class="line">proxy_set_header &#x27;sec-ch-ua&#x27; &quot;&quot;;</span><br><span class="line">proxy_set_header &#x27;sec-ch-ua-mobile&#x27; &quot;&quot;;</span><br><span class="line">proxy_set_header &#x27;sec-ch-ua-platform:&#x27; &quot;&quot;;</span><br><span class="line">proxy_set_header &#x27;Sec-Fetch-Dest&#x27; &quot;&quot;;</span><br><span class="line">proxy_set_header &#x27;Sec-Fetch-Mode&#x27; &quot;&quot;;</span><br><span class="line">proxy_set_header &#x27;Sec-Fetch-Site&#x27; &quot;&quot;;</span><br></pre></td></tr></table></figure>

<p>然后重启nginx,访问你的项目web地址应该就能看到视频图像了.</p>
<p>如果还是看不到就继续爬坑吧!!!</p>
<h2 id="其它可能会出现的问题"><a href="#其它可能会出现的问题" class="headerlink" title="其它可能会出现的问题"></a>其它可能会出现的问题</h2><h6 id="如果出现了-Too-many-header-这个错误"><a href="#如果出现了-Too-many-header-这个错误" class="headerlink" title="如果出现了 Too-many-header 这个错误"></a>如果出现了 Too-many-header 这个错误</h6><p>参考: <a target="_blank" rel="noopener" href="https://www.scaugreen.cn/posts/65442/">https://www.scaugreen.cn/posts/65442/</a></p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>感谢本人在爬坑过程中翻过的所有文章.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/road-to-2018">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/road-to-2018" class="post-title-link" itemprop="url">致2018</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-12-31 22:17:30" itemprop="dateCreated datePublished" datetime="2017-12-31T22:17:30+08:00">2017-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-17 17:21:35" itemprop="dateModified" datetime="2021-11-17T17:21:35+08:00">2021-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BF%83%E8%B7%AF/" itemprop="url" rel="index"><span itemprop="name">心路</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>2017要走,我拦都拦不住!<br>那就让他走吧!<br>先总结一下2017年的计划完成情况!</p>
<p>至少读两本文学书! (只读了一本!未完成)<br>学一门新技术语言! (没有学新的技术语言!未完成)<br>至少看两本技术书籍!(完成)<br>坚持写技术Blog!(未完成)<br>坚持看技术blog!(完成)<br>坚持使用默默背单词!(完成)<br>坚持锻炼身体!(完成)</p>
<p>基于以上各计划的完成情况,自我认为不是太理想.各种原因都有,但这不是借口!希望新的一年严格执行计划!</p>
<p>回顾这一年的点滴,生活和工作都在向着好的方向发展.印证了那句”努力就会有回报!”.我希望自己在新的一年里更加努力!因为我相信明天会美好的!</p>
<p>以下为新年计划:<br>至少读两本文学书!<br>至少学一门新技术!<br>至少看两本技术书籍!<br>坚持写技术Blog!<br>坚持看技术blog!<br>坚持使用默默背单词!<br>坚持锻炼身体!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/rails-tip-sidekiq-async-sendmail">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/rails-tip-sidekiq-async-sendmail" class="post-title-link" itemprop="url">Rails下sidekiq无法异步发送邮件的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-04-02 21:48:18" itemprop="dateCreated datePublished" datetime="2017-04-02T21:48:18+08:00">2017-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-17 17:21:43" itemprop="dateModified" datetime="2021-11-17T17:21:43+08:00">2021-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rails/" itemprop="url" rel="index"><span itemprop="name">Rails</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>我在研究sidekiq异步发送邮件的过程中,遇到了sidekiq无法执行队列中的任务的情况.<br>明明sidekiq的”已进入队列”已经包含了发送邮件的任务,并且我非常确定发送邮件的程序是没有问题的.<br>但是无论怎么尝试,邮件都发送不出去.<br>rails console中看到的入队信息是这样的</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">2.3.0 :015 &gt;</span> OrderMailer.confirm_email(<span class="number">1</span>).deliver_later</span><br><span class="line">Enqueued ActionMailer::DeliveryJob (Job <span class="symbol">ID:</span> a7cda76b-1f01-4f4a-a695-3be1c6bb2640) to Sidekiq(development_mailers) with <span class="symbol">arguments:</span> <span class="string">&quot;OrderMailer&quot;</span>, <span class="string">&quot;confirm_email&quot;</span>, <span class="string">&quot;deliver_now&quot;</span>, <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>这里很明确的指出队列的名称是 development_mailers<br>在我没有查明原因之前我的sidekiq.yml配置项是这样的</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:concurrency</span>: <span class="number">5</span></span><br><span class="line"><span class="symbol">:pidfile</span>: tmp/pids/sidekiq.pid</span><br><span class="line"></span><br><span class="line"><span class="symbol">:queues</span>:</span><br><span class="line">    - default</span><br><span class="line">    - [myqueue, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="symbol">development:</span></span><br><span class="line">  <span class="symbol">:concurrency</span>: <span class="number">5</span></span><br><span class="line"><span class="symbol">staging:</span></span><br><span class="line">  <span class="symbol">:concurrency</span>: <span class="number">10</span></span><br><span class="line"><span class="symbol">production:</span></span><br><span class="line">  <span class="symbol">:concurrency</span>: <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>因为对sidekiq研究不透,当时并没有注意 :queues 这块的含义.<br>在反复google后终于在<a target="_blank" rel="noopener" href="https://gist.github.com/maxivak/690e6c353f65a86a4af9">这篇教程</a>里找到了问题的原因所在.<br>其中有这样一句话,让我恍然大悟:<br>“!!! important. You may need to include new queue names in sidekiq.yml file:”<br>我了个大艹!<br>原来是我没有把 development_mailers 队列加到可执行队列中去.<br>添加后的sidekiq.yml配置项是这样的</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:concurrency</span>: <span class="number">5</span></span><br><span class="line"><span class="symbol">:pidfile</span>: tmp/pids/sidekiq.pid</span><br><span class="line"></span><br><span class="line"><span class="symbol">:queues</span>:</span><br><span class="line">    - default</span><br><span class="line">    - [myqueue, <span class="number">2</span>]</span><br><span class="line">    - development_mailers</span><br><span class="line"></span><br><span class="line"><span class="symbol">development:</span></span><br><span class="line">  <span class="symbol">:concurrency</span>: <span class="number">5</span></span><br><span class="line"><span class="symbol">staging:</span></span><br><span class="line">  <span class="symbol">:concurrency</span>: <span class="number">10</span></span><br><span class="line"><span class="symbol">production:</span></span><br><span class="line">  <span class="symbol">:concurrency</span>: <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>重启sidekiq后,世界美好了!<br>ps:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">:queues</span>:</span><br><span class="line">    - default</span><br><span class="line">    - [myqueue, <span class="number">2</span>]</span><br><span class="line">    - development_mailers</span><br></pre></td></tr></table></figure>
<p>这块的含义是sidekiq可以执行的队列集合,其中 [myqueue, 2] 这里的2 表示被分配到的权重是2.<br>可参考<a target="_blank" rel="noopener" href="http://wdxtub.com/2016/07/06/sidekiq-guide/">这里</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/rails-tip-custom-generator">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/rails-tip-custom-generator" class="post-title-link" itemprop="url">自定义generator</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-03-04 11:57:15" itemprop="dateCreated datePublished" datetime="2017-03-04T11:57:15+08:00">2017-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-17 17:21:46" itemprop="dateModified" datetime="2021-11-17T17:21:46+08:00">2021-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ruby-On-Rails/" itemprop="url" rel="index"><span itemprop="name">Ruby On Rails</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在Rails项目中,scaffold提供了生成初始代码的强大功能.但任然不能满足日常开发需求.针对部分重复的代码手动ctrl+c,ctrl+v总显得太low.如果能自定义scaffold那就完美了.<br>庆幸的是Rails提供了这种功能.下面以我的开源项目opendoc为例,来自定义scaffold.<br>首先来生成generator.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rails generate generator opendoc_scaffold</span><br></pre></td></tr></table></figure>
<p>上面的命令会生成下面这些文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create  lib/generators/opendoc_scaffold</span><br><span class="line">create  lib/generators/opendoc_scaffold/opendoc_scaffold_generator.rb</span><br><span class="line">create  lib/generators/opendoc_scaffold/USAGE</span><br><span class="line">create  lib/generators/opendoc_scaffold/templates</span><br><span class="line">invoke  test_unit</span><br><span class="line">create    <span class="built_in">test</span>/lib/generators/opendoc_scaffold_generator_test.rb</span><br></pre></td></tr></table></figure>
<p>单从名字上看,我们已经大体上知道这些文件是干啥用的了.<br>USAGE是定义一些说明.<br>templates文件夹下放一些模板.<br>opendoc_scaffold_generator.rb是启动文件.内容如下</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpendocScaffoldGenerator</span> &lt; Rails::Generators::<span class="title">NamedBase</span></span></span><br><span class="line">  source_root File.expand_path(<span class="string">&#x27;../templates&#x27;</span>, <span class="keyword">__FILE__</span>) <span class="comment">#指定模板根目录</span></span><br><span class="line">  <span class="comment">#创建一个启动方法,以下代码不是自动生成的</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">copy_opendoc_scaffold_file</span></span></span><br><span class="line">    <span class="comment">#controller</span></span><br><span class="line">    template <span class="string">&#x27;controller.rb&#x27;</span>, <span class="string">&quot;app/controllers/backend/<span class="subst">#&#123;table_name&#125;</span>_controller.rb&quot;</span></span><br><span class="line">    <span class="comment">#model</span></span><br><span class="line">    template <span class="string">&#x27;model.rb&#x27;</span>, <span class="string">&quot;app/models/<span class="subst">#&#123;singular_table_name&#125;</span>.rb&quot;</span></span><br><span class="line">    <span class="comment">#views</span></span><br><span class="line">    copy_file <span class="string">&#x27;erb/new.html.erb&#x27;</span>, <span class="string">&quot;app/views/backend/<span class="subst">#&#123;file_name&#125;</span>/new.html.erb&quot;</span></span><br><span class="line">    copy_file <span class="string">&#x27;erb/edit.html.erb&#x27;</span>, <span class="string">&quot;app/views/backend/<span class="subst">#&#123;file_name&#125;</span>/edit.html.erb&quot;</span></span><br><span class="line">    template <span class="string">&#x27;erb/index.html.erb&#x27;</span>, <span class="string">&quot;app/views/backend/<span class="subst">#&#123;file_name&#125;</span>/index.html.erb&quot;</span></span><br><span class="line">    template <span class="string">&#x27;erb/_form.html.erb&#x27;</span>, <span class="string">&quot;app/views/backend/<span class="subst">#&#123;file_name&#125;</span>/_form.html.erb&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>上诉代码中用到的template方法的意思是复制模板到指定的地方.<br>比如自动生成model.下面这些代码是我自定义的model模板.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">require &#x27;uuidtools&#x27;</span><br><span class="line"></span><br><span class="line">class &lt;%= singular_table_name.capitalize %&gt; &lt; ApplicationRecord</span><br><span class="line">  enum status: [:archived, :active]</span><br><span class="line"></span><br><span class="line">  #validates</span><br><span class="line">  validates :TODO, presence: true, length: &#123; maximum: 50 &#125;</span><br><span class="line">  validates :TODO, numericality: true</span><br><span class="line"></span><br><span class="line">  #scope</span><br><span class="line">  default_scope &#123; where(&quot;status&gt;?&quot;, &lt;%=  singular_table_name.capitalize %&gt;.statuses[:archived]) &#125;</span><br><span class="line">  scope :name_like, -&gt;(name)&#123; where &quot;name like ? &quot;, &quot;%#&#123;sanitize_sql_like(name)&#125;%&quot; &#125;  #防sql注入</span><br><span class="line"></span><br><span class="line">  #假删除</span><br><span class="line">  def self.delete(&lt;%= singular_table_name %&gt;)</span><br><span class="line">    &lt;%= singular_table_name %&gt;.status = :archived</span><br><span class="line">    &lt;%= singular_table_name %&gt;.save</span><br><span class="line">  end</span><br><span class="line"></span><br><span class="line">  #设置属性值</span><br><span class="line">  def self.set_attribute(&lt;%= singular_table_name %&gt;_params)</span><br><span class="line">    &lt;%= singular_table_name %&gt; = &lt;%= singular_table_name.capitalize %&gt;.new(&lt;%= singular_table_name %&gt;_params)</span><br><span class="line">    &lt;%= singular_table_name %&gt;.sid = UUIDTools::UUID.timestamp_create</span><br><span class="line">    &lt;%= singular_table_name %&gt;.status = :active</span><br><span class="line">    &lt;%= singular_table_name %&gt;</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>上面model模板中用到的 singular_table_name 以及 table_name 等这些方法都在 Rails::Generators::NamedBase <a target="_blank" rel="noopener" href="http://api.rubyonrails.org/classes/Rails/Generators/NamedBase.html">这个类下</a>.<br>定义完模板后就可以像使用scaffold一样使用我们的自定义generator了.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails generate opendoc_scaffold groups</span><br><span class="line">rails generate opendoc_scaffold members</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/rails-tip-friendly-id">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/rails-tip-friendly-id" class="post-title-link" itemprop="url">friendly_id的使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-02-06 00:11:18" itemprop="dateCreated datePublished" datetime="2017-02-06T00:11:18+08:00">2017-02-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-17 17:21:45" itemprop="dateModified" datetime="2021-11-17T17:21:45+08:00">2021-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ruby-On-Rails/" itemprop="url" rel="index"><span itemprop="name">Ruby On Rails</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>在我们的项目中如果不对url进行模糊处理,通常的url会像下面这样子:<br><a target="_blank" rel="noopener" href="http://localhost:3000/backend/groups/1/edit">http://localhost:3000/backend/groups/1/edit</a><br><a target="_blank" rel="noopener" href="http://localhost:3000/backend/groups/1/interfaces/1/edit">http://localhost:3000/backend/groups/1/interfaces/1/edit</a><br>这直接暴露了数据库里有多少条记录.为了降低风险,我们需要借助friendly_id这个gem对url进行模糊处理.<br>处理的结果应该是下面这样:<br><a target="_blank" rel="noopener" href="http://localhost:3000/backend/groups/0f7094c6-ec6e-11e6-a542-7cd1c3f0bed9/edit">http://localhost:3000/backend/groups/0f7094c6-ec6e-11e6-a542-7cd1c3f0bed9/edit</a><br><a target="_blank" rel="noopener" href="http://localhost:3000/backend/groups/0f7094c6-ec6e-11e6-a542-7cd1c3f0bed9/interfaces/48e86a4e-ec6e-11e6-a542-7cd1c3f0bed9/edit">http://localhost:3000/backend/groups/0f7094c6-ec6e-11e6-a542-7cd1c3f0bed9/interfaces/48e86a4e-ec6e-11e6-a542-7cd1c3f0bed9/edit</a></p>
<h5 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h5><p>添加<a target="_blank" rel="noopener" href="https://github.com/norman/friendly_id">friendly_id</a>这个gem</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Gemfile</span></span><br><span class="line">gem <span class="string">&#x27;friendly_id&#x27;</span>, <span class="string">&#x27;~&gt; 5.1.0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>按照官方教程进行初始化:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rails g friendly_id</span><br><span class="line">rails <span class="symbol">db:</span>migrate</span><br></pre></td></tr></table></figure>
<h6 id="先来实现编辑group的url模糊处理"><a href="#先来实现编辑group的url模糊处理" class="headerlink" title="先来实现编辑group的url模糊处理"></a>先来实现编辑group的url模糊处理</h6><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先为groups表添加slug字段</span></span><br><span class="line">rails g migration add_column_slug_to_groups <span class="symbol">slug:</span><span class="symbol">string:</span>uuiq</span><br><span class="line">rails <span class="symbol">db:</span>migrate</span><br></pre></td></tr></table></figure>
<p>然后修改group model</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app/modles/group.rb</span></span><br><span class="line"><span class="comment">#添加如下代码</span></span><br><span class="line">extend FriendlyId</span><br><span class="line">friendly_id <span class="symbol">:sid</span>, <span class="symbol">use:</span> <span class="symbol">:slugged</span>  <span class="comment">#使用groups中的sid字段作为slug</span></span><br></pre></td></tr></table></figure>
<p>然后controller中所有查询都通过friendly</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app/controllers/backend/groups_controller.rb</span></span><br><span class="line"><span class="comment">#比如:</span></span><br><span class="line"><span class="variable">@group</span> = Group.friendly.find(params[<span class="symbol">:id</span>])</span><br></pre></td></tr></table></figure>
<p>完成以上操作后即实现了<a target="_blank" rel="noopener" href="http://localhost:3000/backend/groups/1/edit%E8%BF%99%E4%B8%AAurl%E7%9A%84%E6%A8%A1%E7%B3%8A%E5%A4%84%E7%90%86">http://localhost:3000/backend/groups/1/edit这个url的模糊处理</a>.<br>查看<a target="_blank" rel="noopener" href="http://localhost:3000/backend/groups%E7%9A%84html%E4%BD%A0%E4%BC%9A%E5%8F%91%E7%8E%B0">http://localhost:3000/backend/groups的html你会发现</a> 编辑 对应的href的值已经模糊处理,但是删除的href还是没处理的状态.这个时候修改groups/index.html.erb</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#app/views/backend/groups/index.html.erb</span><br><span class="line">&lt;%= link_to &#x27;删除&#x27;, backend_group_path(group.id), method: :delete, data: &#123; confirm: &#x27;确定删除吗?&#x27; &#125;, class: &#x27;edit&#x27;  %&gt;</span><br><span class="line">为</span><br><span class="line">&lt;%= link_to &#x27;删除&#x27;, backend_group_path(group.sid), method: :delete, data: &#123; confirm: &#x27;确定删除吗?&#x27; &#125;, class: &#x27;edit&#x27;  %&gt;</span><br></pre></td></tr></table></figure>
<h6 id="处理interface"><a href="#处理interface" class="headerlink" title="处理interface"></a>处理interface</h6><p>如果现在什么都不做,直接打开interface,你会发现interface的首页无法正常显示数据了.因为用于查询的group_id由数字变成了一长串的字符串.<br>接下来我们修复这个问题.<br>先按照修改group的方式修改interface使用friendly.因为group和interface有has_many关联,所以需要一些特殊处理!</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先为interfaces添加groups的sid外键关联</span></span><br><span class="line">rails g migration add_column_group_sid_to_interfaces <span class="symbol">group_sid:</span><span class="symbol">string:</span>&#123;<span class="number">50</span>&#125;</span><br><span class="line">rails <span class="symbol">db:</span>migrate</span><br></pre></td></tr></table></figure>
<p>然后修改set_attribute方法传入 params[:group_id]</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app/models/intreface.rb</span></span><br><span class="line">def <span class="keyword">self</span>.set_attribute(interface_params, group_sid)</span><br><span class="line">    inter = Interface.new(interface_params)</span><br><span class="line">    inter.sid = UUIDTools::UUID.timestamp_create</span><br><span class="line">    inter.group_sid = group_sid</span><br><span class="line">    inter.status = <span class="number">1</span></span><br><span class="line">    inter</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这样处理后,新增interface的时候,就会把group的sid插入到interface的group_sid字段中.</p>
<h6 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h6><p>也可通过重写model的to_param方法模糊处理url,比如</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_param</span></span></span><br><span class="line">    <span class="string">&quot;<span class="subst">#&#123;id&#125;</span>_slfkjsdf&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>


<p>以上就是friendly_id的简单用法.如有不对的地方欢迎指正!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/rails-error-but-your-gemfile-specified">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/rails-error-but-your-gemfile-specified" class="post-title-link" itemprop="url">Your Ruby version is *, but your Gemfile specified *</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-02-05 12:08:59" itemprop="dateCreated datePublished" datetime="2017-02-05T12:08:59+08:00">2017-02-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-17 17:21:48" itemprop="dateModified" datetime="2021-11-17T17:21:48+08:00">2021-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ruby-On-Rails/" itemprop="url" rel="index"><span itemprop="name">Ruby On Rails</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>错误描述:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Your Ruby version is 2.0.0, but your Gemfile specified 2.3.0</span><br></pre></td></tr></table></figure>
<p>排错过程:</p>
<p>查看ruby版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">✘ ⮀ -&gt; ⮀ openapi ⮀ ruby-2.3.0 ⮀ ⭠ master± ⮀ ruby -v</span><br><span class="line">ruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-darwin15]</span><br></pre></td></tr></table></figure>
<p>查看当前使用的ruby版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> -&gt; ⮀ openapi ⮀ ruby-2.3.0 ⮀ ⭠ master± ⮀ rvm list</span><br><span class="line"></span><br><span class="line">rvm rubies</span><br><span class="line"></span><br><span class="line">   ruby-2.0.0-p247 [ x86_64 ]</span><br><span class="line">   ruby-2.2.0 [ x86_64 ]</span><br><span class="line">   ruby-2.2.1 [ x86_64 ]</span><br><span class="line">=&gt; ruby-2.3.0 [ x86_64 ]</span><br><span class="line"> * ruby-2.3.1 [ x86_64 ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># =&gt; - current</span></span><br><span class="line"><span class="comment"># =* - current &amp;&amp; default</span></span><br><span class="line"><span class="comment">#  * - default</span></span><br></pre></td></tr></table></figure>
<p>错误解决:<br>重新设置当前使用的ruby版本,问题解决!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rvm use 2.3.0</span><br></pre></td></tr></table></figure>
<p>问题原因:<br>不明白!为何rvm已经设置了当前使用的ruby版本是2.3.0,但是还要重新设置一下!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/road-to-2017">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/road-to-2017" class="post-title-link" itemprop="url">致2017</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-31 21:07:51" itemprop="dateCreated datePublished" datetime="2016-12-31T21:07:51+08:00">2016-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-17 17:22:11" itemprop="dateModified" datetime="2021-11-17T17:22:11+08:00">2021-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BF%83%E8%B7%AF/" itemprop="url" rel="index"><span itemprop="name">心路</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>2016稍纵即逝!<br>回顾这一年有喜有悲又有无奈!好在过去的都已过去!<br>展望2017,新的朝阳已经升起,怎能不为自己做一个新的新年规划呢!<br>在新的一年里:<br>至少读两本文学书!<br>学一门新技术语言!<br>至少看两本技术书籍!<br>坚持写技术Blog!<br>坚持看技术blog!<br>坚持使用默默背单词!<br>坚持锻炼身体!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/rails-read-railstutorial4th-notes">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/rails-read-railstutorial4th-notes" class="post-title-link" itemprop="url">《Ruby on Rails 教程》读书笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-29 22:07:13" itemprop="dateCreated datePublished" datetime="2016-08-29T22:07:13+08:00">2016-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-17 17:22:09" itemprop="dateModified" datetime="2021-11-17T17:22:09+08:00">2021-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ruby-On-Rails/" itemprop="url" rel="index"><span itemprop="name">Ruby On Rails</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h5 id="编写测试的指导方针"><a href="#编写测试的指导方针" class="headerlink" title="编写测试的指导方针"></a>编写测试的指导方针</h5><p>与应用代码相比,如果测试代码特别简短,倾向于先编写测试;<br>如果对想实现的功能不是特别清楚,倾向于先编写应用代码,然后再编写测试,并改进实现方式;<br>安全是头等大事,保险起见,要为安全相关的功能线编写测试;<br>只要发现一个问题,就编写一个测试重现这种问题,避免回归,然后再编写应用代码修正问题;<br>尽量不为以后可能修改的代码(例如HTML结构的细节)编写测试;<br>重构之前要编写测试,集中测试容易出错的代码.<br>在实际的开发中,根据上述方针,我们一般先编写控制器和模型测试,然后再编写集成测试(测试模型、试视图和控制器在一起时的表现)。如果应用代码很容易出错，或者经常变动（视图就是这样），我们就完全不测试。</p>
<h5 id="assert-select"><a href="#assert-select" class="headerlink" title="assert_select"></a>assert_select</h5><p>test中的辅助函数,用于检测html中是否有指定的html标签,这个方法有时也叫”选择符”<br>assert_select ‘title’,’Home I Ruby on Rails Tutorial Sample App’ #含义: 检测有没有&lt; title &gt;标签,以及其中的内容是不是 “Home I Ruby on Rails Tutorial Sample App”<br>一些用法:<br>| 代码        | 匹配HTML         |<br>| ————- |:————-:|<br>| assert_select ‘div’      | &lt; div&gt;foobar&lt; /div&gt; |<br>| assert_select ‘div’,’foobar’     | &lt; div&gt;foorbar&lt; /div&gt; |<br>| assert_select ‘div.nav’     | &lt; div class=’nav’&gt;foorbar&lt; /div&gt; |<br>| assert_select ‘div#profile’     | &lt; div id=’profile’&gt;foorbar&lt; /div&gt; |<br>| assert_select ‘div[name=yo]’     | &lt; div name=’yo’&gt;hey&lt; /div&gt; |<br>| assert_select “a[href=?]”,’/‘,count:1    | &lt; div href=’/‘&gt;foo&lt; /div&gt; |<br>| assert_select “a[href=?]”,’/‘,text: “foo”    | &lt; div href=’/‘&gt;foo&lt; /div&gt; |</p>
<p>选择这样一个input标签的assert_select写法为:<br>&lt; input id=”email” name=”email” type=”hidden” value=”<a href="mailto:&#97;&#64;&#109;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;">&#97;&#64;&#109;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;</a>“ / &gt;<br>assert_select “input[name=email][type=hidden][value=?]”, ‘<a href="mailto:&#97;&#x40;&#109;&#97;&#105;&#108;&#x2e;&#99;&#x6f;&#109;">&#97;&#x40;&#109;&#97;&#105;&#108;&#x2e;&#99;&#x6f;&#109;</a>‘</p>
<h5 id="provide-帮助方法"><a href="#provide-帮助方法" class="headerlink" title="provide 帮助方法"></a>provide 帮助方法</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;% provide(<span class="symbol">:title</span>, <span class="string">&quot;Home&quot;</span>) %&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;&lt;%= <span class="keyword">yield</span>(<span class="symbol">:title</span>) %&gt;&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">&lt;/head</span>&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="使用git开发的步骤"><a href="#使用git开发的步骤" class="headerlink" title="使用git开发的步骤"></a>使用git开发的步骤</h5><p>有新的需求时,创建一个分支,再分支上进行开发,开发完成后合并到主分支.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout master #切换到master分支</span><br><span class="line">git merge static-pages #把static-pages分支merge到master分支</span><br></pre></td></tr></table></figure>
<h5 id="ps-命令"><a href="#ps-命令" class="headerlink" title="ps 命令"></a>ps 命令</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux  <span class="comment">#查看系统进程</span></span><br><span class="line">ps aux | grep spring <span class="comment">#查找spring</span></span><br></pre></td></tr></table></figure>
<h5 id="Guard的配置"><a href="#Guard的配置" class="headerlink" title="Guard的配置"></a>Guard的配置</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># Defines the matching rules for Guard.</span></span><br><span class="line">guard <span class="symbol">:minitest</span>, <span class="symbol">spring:</span> <span class="literal">true</span>, <span class="symbol">all_on_start:</span> <span class="literal">false</span> <span class="keyword">do</span></span><br><span class="line">    watch(<span class="regexp">%r&#123;^test/(.*)/?(.*)_test\.rb$&#125;</span>)</span><br><span class="line">    watch(<span class="string">&#x27;test/test_helper.rb&#x27;</span>) &#123; <span class="string">&#x27;test&#x27;</span> &#125;</span><br><span class="line">    watch(<span class="string">&#x27;config/routes.rb&#x27;</span>) &#123; integration_tests &#125;</span><br><span class="line">    watch(<span class="regexp">%r&#123;^app/models/(.*?)\.rb$&#125;</span>) <span class="keyword">do</span> <span class="params">|matches|</span></span><br><span class="line">        <span class="string">&quot;test/models/<span class="subst">#&#123;matches[<span class="number">1</span>]&#125;</span>_test.rb&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    watch(<span class="regexp">%r&#123;^app/controllers/(.*?)_controller\.rb$&#125;</span>) <span class="keyword">do</span> <span class="params">|matches|</span></span><br><span class="line">        resource_tests(matches[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    watch(<span class="regexp">%r&#123;^app/views/([^/]*?)/.*\.html\.erb$&#125;</span>) <span class="keyword">do</span> <span class="params">|matches|</span></span><br><span class="line">            [<span class="string">&quot;test/controllers/<span class="subst">#&#123;matches[<span class="number">1</span>]&#125;</span>_controller_test.rb&quot;</span>] +</span><br><span class="line">        integration_tests(matches[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    watch(<span class="regexp">%r&#123;^app/helpers/(.*?)_helper\.rb$&#125;</span>) <span class="keyword">do</span> <span class="params">|matches|</span></span><br><span class="line">        integration_tests(matches[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    watch(<span class="string">&#x27;app/views/layouts/application.html.erb&#x27;</span>) <span class="keyword">do</span></span><br><span class="line">            <span class="string">&#x27;test/integration/site_layout_test.rb&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    watch(<span class="string">&#x27;app/helpers/sessions_helper.rb&#x27;</span>) <span class="keyword">do</span></span><br><span class="line">        integration_tests &lt;&lt; <span class="string">&#x27;test/helpers/sessions_helper_test.rb&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    watch(<span class="string">&#x27;app/controllers/sessions_controller.rb&#x27;</span>) <span class="keyword">do</span> [<span class="string">&#x27;test/controllers/sessions_controller_test.rb&#x27;</span>,<span class="string">&#x27;test/integration/users_login_test.rb&#x27;</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    watch(<span class="string">&#x27;app/controllers/account_activations_controller.rb&#x27;</span>) <span class="keyword">do</span> <span class="string">&#x27;test/integration/users_signup_test.rb&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    watch(<span class="regexp">%r&#123;app/views/users/*&#125;</span>) <span class="keyword">do</span></span><br><span class="line">            resource_tests(<span class="string">&#x27;users&#x27;</span>) +</span><br><span class="line">    [<span class="string">&#x27;test/integration/microposts_interface_test.rb&#x27;</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Returns the integration tests corresponding to the given resource.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">integration_tests</span><span class="params">(resource = <span class="symbol">:all</span>)</span></span> <span class="keyword">if</span> resource == <span class="symbol">:all</span></span><br><span class="line">    Dir[<span class="string">&quot;test/integration/*&quot;</span>] <span class="keyword">else</span></span><br><span class="line">    Dir[<span class="string">&quot;test/integration/<span class="subst">#&#123;resource&#125;</span>_*.rb&quot;</span>] <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Returns the controller tests corresponding to the given resource.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">controller_test</span><span class="params">(resource)</span></span> <span class="string">&quot;test/controllers/<span class="subst">#&#123;resource&#125;</span>_controller_test.rb&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">    <span class="comment"># Returns all tests for the given resource.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resource_tests</span><span class="params">(resource)</span></span></span><br><span class="line">    integration_tests(resource) &lt;&lt; controller_test(resource)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">#下面这行会让 Guard 使用 Rails 提供的 Spring 服务器减少加载时间,而且启动时不运行整个测试组件。</span></span><br><span class="line">guard <span class="symbol">:minitest</span>, <span class="symbol">spring:</span> <span class="literal">true</span>, <span class="symbol">all_on_start:</span> <span class="literal">false</span> <span class="keyword">do</span></span><br><span class="line"><span class="comment">#使用 Guard 时,为了避免 Spring 和 Git 发生冲突,应该把 spring/ 文件夹加到 .gitignore 文件中,让 Git 忽 略这个文件夹。</span></span><br></pre></td></tr></table></figure>
<h5 id="bang方法约定"><a href="#bang方法约定" class="headerlink" title="bang方法约定"></a>bang方法约定</h5><p>方法名后加一个感叹号的方法称为”炸弹”(bang)方法.bang方法的含义是 方法处理的结果会改变对象的值.比如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2.3.1 :001 &gt; a = %w(2 3 5)</span><br><span class="line"> =&gt; [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;5&quot;</span>]</span><br><span class="line">2.3.1 :002 &gt; a.sort</span><br><span class="line"> =&gt; [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;5&quot;</span>]</span><br><span class="line">2.3.1 :003 &gt; a = %w(5 9 2)</span><br><span class="line"> =&gt; [<span class="string">&quot;5&quot;</span>, <span class="string">&quot;9&quot;</span>, <span class="string">&quot;2&quot;</span>]</span><br><span class="line">2.3.1 :004 &gt; a.sort</span><br><span class="line"> =&gt; [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;9&quot;</span>]</span><br><span class="line">2.3.1 :005 &gt; a</span><br><span class="line"> =&gt; [<span class="string">&quot;5&quot;</span>, <span class="string">&quot;9&quot;</span>, <span class="string">&quot;2&quot;</span>]</span><br><span class="line">2.3.1 :006 &gt; a.sort!</span><br><span class="line"> =&gt; [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;9&quot;</span>]</span><br><span class="line">2.3.1 :007 &gt; a</span><br><span class="line"> =&gt; [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;9&quot;</span>]</span><br></pre></td></tr></table></figure>
<h5 id="数组的-push-lt-lt"><a href="#数组的-push-lt-lt" class="headerlink" title="数组的 push | &lt;&lt;"></a>数组的 push | &lt;&lt;</h5><p>为数组添加元素可以使用 push方法,也可以使用 &lt;&lt; 运算符.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2.3.1 :008 &gt; a &lt;&lt; <span class="string">&#x27;bbb&#x27;</span> &lt;&lt; <span class="string">&#x27;dddd&#x27;</span></span><br><span class="line"> =&gt; [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;9&quot;</span>, <span class="string">&quot;bbb&quot;</span>, <span class="string">&quot;dddd&quot;</span>]</span><br></pre></td></tr></table></figure>
<h5 id="map块变量调用方法简写形式-amp"><a href="#map块变量调用方法简写形式-amp" class="headerlink" title="map块变量调用方法简写形式 &amp;"></a>map块变量调用方法简写形式 &amp;</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">2.3.1 :011 &gt;</span> a.map &#123;<span class="params">|item|</span> item.upcase &#125;</span><br><span class="line"> =&gt; [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;9&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;DDDD&quot;</span>]</span><br><span class="line"><span class="meta">2.3.1 :012 &gt;</span> a.map(&amp;<span class="symbol">:downcase</span>)</span><br><span class="line"> =&gt; [<span class="string">&quot;2&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;9&quot;</span>, <span class="string">&quot;bbb&quot;</span>, <span class="string">&quot;dddd&quot;</span>]</span><br></pre></td></tr></table></figure>
<h5 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#几种写法 及 多层嵌套后的hash取值方式</span></span><br><span class="line"><span class="meta">2.3.1 :001 &gt;</span> a = &#123; <span class="string">&quot;a1&quot;</span> =&gt; <span class="number">1</span>, <span class="string">&quot;a2&quot;</span> =&gt; <span class="number">2</span>  &#125;</span><br><span class="line"> =&gt; &#123;<span class="string">&quot;a1&quot;</span>=&gt;<span class="number">1</span>, <span class="string">&quot;a2&quot;</span>=&gt;<span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">2.3.1 :002 &gt;</span> b = &#123; <span class="symbol">:b1</span> =&gt; <span class="number">1</span>, <span class="symbol">:b2</span> =&gt; <span class="number">2</span> &#125;</span><br><span class="line"> =&gt; &#123;<span class="symbol">:b1=&gt;</span><span class="number">1</span>, <span class="symbol">:b2=&gt;</span><span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">2.3.1 :003 &gt;</span> c = &#123; <span class="symbol">c1:</span> <span class="number">1</span>, <span class="symbol">c2:</span> <span class="number">2</span> &#125;</span><br><span class="line"> =&gt; &#123;<span class="symbol">:c1=&gt;</span><span class="number">1</span>, <span class="symbol">:c2=&gt;</span><span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">#多层嵌套后的hash取值</span></span><br><span class="line"> <span class="number">2.3</span>.<span class="number">1</span> <span class="symbol">:</span><span class="number">004</span> &gt; d = &#123; <span class="symbol">d1:</span> &#123; <span class="symbol">dd1:</span> &#123; <span class="symbol">ddd1:</span> <span class="number">6</span>, <span class="symbol">ddd2:</span> <span class="number">7</span>&#125;, <span class="symbol">dd2:</span> <span class="number">4</span> &#125;, <span class="symbol">d2:</span> <span class="number">3</span> &#125;</span><br><span class="line"> =&gt; &#123;<span class="symbol">:d1=&gt;</span>&#123;<span class="symbol">:dd1=&gt;</span>&#123;<span class="symbol">:ddd1=&gt;</span><span class="number">6</span>, <span class="symbol">:ddd2=&gt;</span><span class="number">7</span>&#125;, <span class="symbol">:dd2=&gt;</span><span class="number">4</span>&#125;, <span class="symbol">:d2=&gt;</span><span class="number">3</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">2.3.1 :011 &gt;</span> d[<span class="symbol">:d1</span>]</span><br><span class="line"> =&gt; &#123;<span class="symbol">:dd1=&gt;</span>&#123;<span class="symbol">:ddd1=&gt;</span><span class="number">6</span>, <span class="symbol">:ddd2=&gt;</span><span class="number">7</span>&#125;, <span class="symbol">:dd2=&gt;</span><span class="number">4</span>&#125;</span><br><span class="line"><span class="meta">2.3.1 :012 &gt;</span> d[<span class="symbol">:d1</span>][<span class="symbol">:dd1</span>]</span><br><span class="line"> =&gt; &#123;<span class="symbol">:ddd1=&gt;</span><span class="number">6</span>, <span class="symbol">:ddd2=&gt;</span><span class="number">7</span>&#125;</span><br><span class="line"><span class="meta">2.3.1 :013 &gt;</span> d[<span class="symbol">:d1</span>][<span class="symbol">:dd1</span>][<span class="symbol">:ddd2</span>]</span><br><span class="line"> =&gt; <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#hash的merge方法</span></span><br><span class="line"><span class="meta">2.3.1 :018 &gt;</span> a</span><br><span class="line"> =&gt; &#123;<span class="string">&quot;a1&quot;</span>=&gt;<span class="number">1</span>, <span class="string">&quot;a2&quot;</span>=&gt;<span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">2.3.1 :019 &gt;</span> b</span><br><span class="line"> =&gt; &#123;<span class="symbol">:b1=&gt;</span><span class="number">1</span>, <span class="symbol">:b2=&gt;</span><span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">2.3.1 :020 &gt;</span> a.merge b</span><br><span class="line"> =&gt; &#123;<span class="string">&quot;a1&quot;</span>=&gt;<span class="number">1</span>, <span class="string">&quot;a2&quot;</span>=&gt;<span class="number">2</span>, <span class="symbol">:b1=&gt;</span><span class="number">1</span>, <span class="symbol">:b2=&gt;</span><span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#函数调用时,如果哈希是最后一个参数,可以省略花括号.比如:</span></span><br><span class="line">stylesheet_link_tag <span class="string">&#x27;application&#x27;</span>, &#123; <span class="symbol">media:</span> <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;data-turbolinks-track&#x27;</span>: <span class="string">&#x27;reload&#x27;</span>&#125;</span><br><span class="line">stylesheet_link_tag <span class="string">&#x27;application&#x27;</span>, <span class="symbol">media:</span> <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;data-turbolinks-track&#x27;</span>: <span class="string">&#x27;reload&#x27;</span></span><br></pre></td></tr></table></figure>
<h5 id="字符串、数组、hash、Range的声明"><a href="#字符串、数组、hash、Range的声明" class="headerlink" title="字符串、数组、hash、Range的声明"></a>字符串、数组、hash、Range的声明</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&#x27;&#x27;</span></span><br><span class="line">a = String.new</span><br><span class="line">a = String.new(<span class="string">&#x27;dd&#x27;</span>)</span><br><span class="line">b = []</span><br><span class="line">b = Array.new</span><br><span class="line">c = &#123;&#125;</span><br><span class="line">c = Hash.new</span><br><span class="line">d = Range.new(<span class="number">0</span>,<span class="number">2</span>)  <span class="comment">#声明一个范围</span></span><br></pre></td></tr></table></figure>
<h5 id="预处理引擎的执行顺序"><a href="#预处理引擎的执行顺序" class="headerlink" title="预处理引擎的执行顺序"></a>预处理引擎的执行顺序</h5><p>从右向左执行<br>foobar.js.erb.coffee #先通过coffee处理,再通过ruby处理</p>
<h5 id="路由的-path-和-url"><a href="#路由的-path-和-url" class="headerlink" title="路由的 _path 和 _url"></a>路由的 _path 和 _url</h5><p>root_path -&gt; ‘/‘<br>root_url -&gt; ‘<a target="_blank" rel="noopener" href="http://www.example.com/&#39;">http://www.example.com/&#39;</a><br>约定 只有重定向使用_url形式,其余都使用_path形式.(因为HTTP标准严格要求重定向的URL必须完整.不过在大多数浏览器中,两种形式都可以正常使用)</p>
<h5 id="测试方法-assert-template"><a href="#测试方法-assert-template" class="headerlink" title="测试方法 assert_template"></a>测试方法 assert_template</h5><p>检查路由是否使用正确的视图渲染<br>get root_path<br>assert_template ‘static_pages/home’<br>#请求root路由,看root路由是否使用了static_pages下的home视图渲染.</p>
<h5 id="沙盒模式"><a href="#沙盒模式" class="headerlink" title="沙盒模式"></a>沙盒模式</h5><p>rails console –sandbox<br>在沙盒模式下做的所有修改都不会影响实际数据.<br>在控制台下可以使用 reload方法重新加载环境</p>
<h5 id="ActiveRecord的一些方法"><a href="#ActiveRecord的一些方法" class="headerlink" title="ActiveRecord的一些方法"></a>ActiveRecord的一些方法</h5><p>user.new #在内存中创建对象<br>user.save #保存到数据库,save方法会返回true和false<br>以上两步和<br>user.create #create方法会返回对象的实例<br>等效.<br>user.valid? #只检测对象是否有效<br>user.destroy #create方法的逆操作,也会返回对象的实例.(销毁的对象还在内存中)<br>user.update_attributes(name: ‘The Dude’, email: ‘<a href="mailto:&#100;&#117;&#x64;&#101;&#64;&#97;&#x62;&#x69;&#x64;&#101;&#115;&#x2e;&#111;&#114;&#x67;">&#100;&#117;&#x64;&#101;&#64;&#97;&#x62;&#x69;&#x64;&#101;&#115;&#x2e;&#111;&#114;&#x67;</a>‘) #更新name和email属性,返回ture和false.该方法无法跳过验证<br>user.update_attribute(:name, ‘El Duderino’) #更新单个属性,该方法可以跳过验证<br>User.find(params[:id]).destroy #可以再查询到的结果上直接调用destroy方法删除对象,物理删除…</p>
<h5 id="Model的验证"><a href="#Model的验证" class="headerlink" title="Model的验证"></a>Model的验证</h5><p>validate :email, format: { with: /<regular expression>/ } #validate可以有format参数,提供正则验证</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VALID_EMAIL_REGEX = <span class="regexp">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span></span><br><span class="line">validates <span class="symbol">:email</span>, <span class="symbol">presence:</span> <span class="literal">true</span>, <span class="symbol">length:</span> &#123;<span class="symbol">maximum:</span> <span class="number">255</span> &#125;, <span class="symbol">format:</span> &#123;<span class="symbol">with:</span> VALID_EMAIL_REGEX &#125;</span><br></pre></td></tr></table></figure>
<h5 id="正则表达式-i-g-m-gi-ig-区别"><a href="#正则表达式-i-g-m-gi-ig-区别" class="headerlink" title="正则表达式 /i,/g,/m,/gi,/ig 区别"></a>正则表达式 /i,/g,/m,/gi,/ig 区别</h5><p>/i (忽略大小写)<br>/g (全文查找出现的所有匹配字符)<br>/m (多行查找)<br>/gi(全文查找、忽略大小写)<br>/ig(全文查找、忽略大小写)</p>
<h5 id="产生7位随机的字符"><a href="#产生7位随机的字符" class="headerlink" title="产生7位随机的字符"></a>产生7位随机的字符</h5><p>(‘a’..’z’).to_a.shuffle[0..7].join</p>
<h5 id="dup方法复制一个对象"><a href="#dup方法复制一个对象" class="headerlink" title="dup方法复制一个对象"></a>dup方法复制一个对象</h5><p>duplicate_user = @user.dup</p>
<h5 id="model的-before-save-方法"><a href="#model的-before-save-方法" class="headerlink" title="model的 before_save 方法"></a>model的 before_save 方法</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></span><br><span class="line">    before_save &#123; <span class="keyword">self</span>.email = email.downcase &#125; <span class="comment">#在执行save方法前,先把email转换为小写</span></span><br><span class="line">    validates <span class="symbol">:name</span>, <span class="symbol">presence:</span> <span class="literal">true</span>, <span class="symbol">length:</span> &#123; <span class="symbol">maximum:</span> <span class="number">50</span> &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h5 id="has-secure-password-方法"><a href="#has-secure-password-方法" class="headerlink" title="has_secure_password 方法"></a>has_secure_password 方法</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">calss User &lt; ApplicationRecord</span><br><span class="line">    has_secure_password</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在模型中调用了该方法后,会自动添加以下功能:<br>在数据库中的password_digest列存储安全的密码哈希值;<br>获得一对虚拟属性,password和password_confirmation,而且创建用户对象时会执行存在性验证和匹配验证;<br>获得authenticate方法,如果密码正确,返回对应的用户对象,否则返回false;<br>这个方法需要表有 password_digest字段.</p>
<h5 id="可以根据环境的不同展示debug信息"><a href="#可以根据环境的不同展示debug信息" class="headerlink" title="可以根据环境的不同展示debug信息"></a>可以根据环境的不同展示debug信息</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% debug(params) if Rails.env.development?  % &gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="在指定的环境下执行命令"><a href="#在指定的环境下执行命令" class="headerlink" title="在指定的环境下执行命令"></a>在指定的环境下执行命令</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rails console test <span class="comment">#在test环境下启用rails console</span></span><br><span class="line">rails server --enviroment production <span class="comment">#在production环境下运行服务</span></span><br><span class="line">rails <span class="symbol">db:</span>migrate RAILS_ENV=production <span class="comment">#迁移production环境数据库</span></span><br><span class="line"><span class="comment">#控制台,服务器,迁移命令 这几个命令中都可以使用RAILS_ENV=&lt;env&gt;,比如: RAILS_ENV=production rails server</span></span><br></pre></td></tr></table></figure>
<h5 id="健壮参数"><a href="#健壮参数" class="headerlink" title="健壮参数"></a>健壮参数</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params.<span class="keyword">require</span>(<span class="symbol">:user</span>).permit(<span class="symbol">:name</span>,<span class="symbol">:email</span>,<span class="symbol">:password</span>,<span class="symbol">:password_confirmation</span>)</span><br></pre></td></tr></table></figure>
<h5 id="model的erros对象"><a href="#model的erros对象" class="headerlink" title="model的erros对象"></a>model的erros对象</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user.errors.full_messages <span class="comment">#查看所有错误信息,是一个数组</span></span><br><span class="line">user.errors.empty? <span class="comment">#判断是否存在错误信息</span></span><br><span class="line">user.errors.any?  <span class="comment">#判断是否存在错误信息,可以empty?含义相反</span></span><br></pre></td></tr></table></figure>
<h5 id="helper的pluralize方法"><a href="#helper的pluralize方法" class="headerlink" title="helper的pluralize方法"></a>helper的pluralize方法</h5><p>该方法返回正确的单复数形式</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helper.pluralize(<span class="number">1</span>,<span class="string">&quot;error&quot;</span>) <span class="comment"># 1 error</span></span><br><span class="line">helper.pluralize(<span class="number">2</span>,<span class="string">&quot;error&quot;</span>) <span class="comment"># 2 errors</span></span><br></pre></td></tr></table></figure>
<h5 id="redirect-to"><a href="#redirect-to" class="headerlink" title="redirect_to"></a>redirect_to</h5><p>redirect_to @user<br>redirect_to user_url(@user)<br>以上两种形式的含义相同</p>
<h5 id="或等运算符"><a href="#或等运算符" class="headerlink" title="||= 或等运算符"></a>||= 或等运算符</h5><p>a ||= b<br>相当于 a = a || b<br>当a为真时返回a的值,当a为假时返回b的值</p>
<h5 id="if-a-b"><a href="#if-a-b" class="headerlink" title="if(a=b)"></a>if(a=b)</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line">b = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">if</span> a = b</span><br><span class="line">  puts a</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  puts <span class="number">3</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>上面的代码意思是当b存在时,把b赋给a,然后打印a,当b不存在时,打印3</p>
<h5 id="activerecord的new-record-方法"><a href="#activerecord的new-record-方法" class="headerlink" title="activerecord的new_record?方法"></a>activerecord的new_record?方法</h5><p>User.new.new_record? # true<br>User.first.new_record? #false<br>用于检测对象是新创建的还是存在于数据库中.</p>
<h5 id="model的validates允许为空的验证"><a href="#model的validates允许为空的验证" class="headerlink" title="model的validates允许为空的验证"></a>model的validates允许为空的验证</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validates <span class="symbol">:password</span>, <span class="symbol">presence:</span> <span class="literal">true</span>, <span class="symbol">length:</span> &#123;<span class="symbol">minimum:</span> <span class="number">6</span>&#125;, <span class="symbol">allow_nil:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h5 id="权限验证使用过滤器实现"><a href="#权限验证使用过滤器实现" class="headerlink" title="权限验证使用过滤器实现"></a>权限验证使用过滤器实现</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationController</span> &lt; ApplicationController</span></span><br><span class="line">    before_action <span class="symbol">:logged_in_user</span>, <span class="symbol">only:</span> [<span class="symbol">:edit</span>, <span class="symbol">:update</span>]</span><br><span class="line">    before_action <span class="symbol">:correct_user</span>, <span class="symbol">only:</span> [<span class="symbol">:edit</span>, <span class="symbol">:update</span>]</span><br><span class="line"></span><br><span class="line">    private</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">loggent_in_user</span></span></span><br><span class="line">            <span class="keyword">unless</span> logged_in?</span><br><span class="line">                flash[<span class="symbol">:danger</span>] = <span class="string">&#x27;.....&#x27;</span></span><br><span class="line">                redirect_to login_url</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">correct_user</span></span></span><br><span class="line">            <span class="variable">@user</span> = User.find(params[<span class="symbol">:id</span>])</span><br><span class="line">            redirect_to(root_url) <span class="keyword">unless</span> <span class="variable">@user</span> == current_user</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>删除用户的链接只有管理员才能看到</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;% <span class="keyword">if</span> current_user.admin? &amp;&amp; !current_user?(user) % &gt;</span><br><span class="line">&lt;% link_to <span class="string">&quot;delete&quot;</span>, user, <span class="symbol">method:</span> <span class="symbol">:delete</span>, <span class="symbol">data:</span> &#123;<span class="symbol">confirm:</span> <span class="string">&#x27;You sure?&#x27;</span>&#125; % &gt;</span><br><span class="line">&lt;% <span class="keyword">end</span> % &gt;</span><br></pre></td></tr></table></figure>
<p>为了限制只有管理员才能删除用户信息,需要这样做</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> &lt; ApplicationController</span></span><br><span class="line">    before_action <span class="symbol">:admin_user</span>, <span class="symbol">only:</span> <span class="symbol">:destroy</span></span><br><span class="line"></span><br><span class="line">    private</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">admin_user</span></span></span><br><span class="line">            redirect_to(root_url) <span class="keyword">unless</span> current_user.admin?</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在数据保存,创建之前都有相应的过滤器<br>比如: before_create, before_save 等</p>
<h5 id="send方法"><a href="#send方法" class="headerlink" title="send方法"></a>send方法</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">2.3.1 :004 &gt;</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"> =&gt; [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="meta">2.3.1 :005 &gt;</span> a.length</span><br><span class="line"> =&gt; <span class="number">3</span></span><br><span class="line"><span class="meta">2.3.1 :006 &gt;</span> a.send(<span class="symbol">:length</span>)</span><br><span class="line"> =&gt; <span class="number">3</span></span><br><span class="line"><span class="meta">2.3.1 :007 &gt;</span> a.send(<span class="string">&quot;length&quot;</span>)</span><br><span class="line"> =&gt; <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>可见send方法可以在对象上调用以字符串或符号方式传入的参数的方法</p>
<h5 id="flash"><a href="#flash" class="headerlink" title="flash"></a>flash</h5><p>falsh[:info] = “111” #用在redirect_to中,数据存在session中<br>falsh.now[:danger] = “111” #用在render中,数据存在request中</p>
<h5 id="has-many-和-belongs-to"><a href="#has-many-和-belongs-to" class="headerlink" title="has_many 和 belongs_to"></a>has_many 和 belongs_to</h5><p>当micropost模型和 user模型进行 belongs_to/has_many关联后会获得这些方法:<br>micropost.user #返回与微博关联的用户对象<br>user.microposts #返回用户发布的所有微博<br>user.microposts.create(arg) #创建一篇user发布的微博<br>user.microposts.create!(arg) #创建一篇user发布的微博(失败时抛出异常)<br>user.microposts.build(arg) #返回一个user发布的新微博对象<br>user.microposts.find_by(id:1) #查找user发布的一篇微博,而且微博的id为1</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Micropost</span> &lt; ApplicationRecord</span></span><br><span class="line">    belongs_to <span class="symbol">:user</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> &lt; ApplicationRecord</span></span><br><span class="line">    has_many <span class="symbol">:microposts</span>, <span class="symbol">dependent:</span> <span class="symbol">:destroy</span>  <span class="comment">#dependent: :destroy 的作用是再用户被删除的时候,把这个用户发布的微博也删除.</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h5 id="scope"><a href="#scope" class="headerlink" title="scope"></a>scope</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Micropost</span> &lt; ApplicationRecord</span></span><br><span class="line">    belongs_to <span class="symbol">:user</span></span><br><span class="line">    default_scope -&gt; &#123; order(<span class="symbol">create_ar:</span> <span class="symbol">:desc</span>) &#125; <span class="comment">#默认的scope</span></span><br><span class="line">    scope <span class="symbol">:tmp</span>, -&gt; &#123;  &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h5 id="Proc-procedure-匿名函数"><a href="#Proc-procedure-匿名函数" class="headerlink" title="Proc(procedure) 匿名函数"></a>Proc(procedure) 匿名函数</h5><p>-&gt; 接受一个代码块,返回一个Proc,然后再这个Proc上调用call方法执行其中代码.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">2.3.1 :002 &gt;</span> a = -&gt; &#123; puts <span class="string">&#x27;b&#x27;</span> &#125;</span><br><span class="line"> =&gt; #&lt;Proc:0x007f9f338bfc98@(irb):2 (lambda)&gt;</span><br><span class="line"><span class="meta">2.3.1 :003 &gt;</span> a.call</span><br><span class="line">b</span><br><span class="line"> =&gt; nil</span><br><span class="line"><span class="meta">2.3.1 :004 &gt;</span> -&gt; &#123; puts <span class="string">&#x27;c&#x27;</span> &#125;.call</span><br><span class="line">c</span><br><span class="line"> =&gt; nil</span><br></pre></td></tr></table></figure>
<h4 id="render传递参数"><a href="#render传递参数" class="headerlink" title="render传递参数"></a>render传递参数</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= for_for(<span class="variable">@micropost</span>) <span class="keyword">do</span> <span class="params">|f|</span>  % &gt;</span><br><span class="line">&lt;%= render <span class="string">&#x27;shared/error_mesages&#x27;</span>, <span class="symbol">object:</span> f.object % &gt;</span><br><span class="line">&lt;% <span class="keyword">end</span> % &gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#app/views/shared/_error_messages.html</span></span><br><span class="line">&lt;% <span class="keyword">if</span> object.errors.any? % &gt;</span><br><span class="line">    &lt;div id=<span class="string">&quot;error&quot;</span> &gt;<span class="number">1</span> &lt;\/ div &gt;</span><br><span class="line">&lt; % <span class="keyword">end</span> % &gt;</span><br></pre></td></tr></table></figure>









      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dodoliu.github.io/hexo-error-module-did-not-self-register">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dodoliu">
      <meta itemprop="description" content="爱生活，爱折腾！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dodoliu的折腾笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/hexo-error-module-did-not-self-register" class="post-title-link" itemprop="url">Hexo Error:Module did not self-register</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-11 08:28:05" itemprop="dateCreated datePublished" datetime="2016-08-11T08:28:05+08:00">2016-08-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-17 17:21:59" itemprop="dateModified" datetime="2021-11-17T17:21:59+08:00">2021-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo/" itemprop="url" rel="index"><span itemprop="name">Hexo</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在启动hexo服务时遇到该问题.</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hexo s</span><br><span class="line">[Error: Module did not self-register.]</span><br><span class="line">&#123; [Error: Cannot find module &#x27;./build/default/DTraceProviderBindings&#x27;] code:&#x27;MODULE<span class="emphasis">_NOT_</span>FOUND&#x27; &#125;</span><br><span class="line">&#123; [Error: Cannot find module &#x27;./build/Debug/DTraceProviderBindings&#x27;] code:&#x27;MODULE<span class="emphasis">_NOT_</span>FOUND&#x27; &#125;</span><br><span class="line">INFO  Start processing</span><br><span class="line">INFO  Hexo is running at http://localhost:4000/. Press Ctrl+C to stop.</span><br></pre></td></tr></table></figure>
<p>分析原因,应该是昨天安装了iTerm后使用了zsh,然后好多命令都找不到了…然后各种幺蛾子问题都出来了!!!<br>这是因为mac默认使用的是bash,现在设置成zsh后,好多命令都不存在了…最简单的方式是就重装一次!!!!<br>我再尝试 升级 nvm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.31.4/install.sh | bash</span><br></pre></td></tr></table></figure>
<p>然后重装 node和hexo后解决了该问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvm install node</span><br><span class="line">npm install hexo --no-optional</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">dodoliu</p>
  <div class="site-description" itemprop="description">爱生活，爱折腾！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dodoliu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
